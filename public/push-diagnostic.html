<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Push Notification Diagnostic - Adoras</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 20px;
      background: #f5f9e9;
      color: #36453b;
    }
    
    .container {
      max-width: 600px;
      margin: 0 auto;
    }
    
    h1 {
      margin-bottom: 20px;
      color: #36453b;
    }
    
    .section {
      background: white;
      padding: 20px;
      margin-bottom: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    h2 {
      margin-bottom: 10px;
      font-size: 18px;
    }
    
    .status {
      display: flex;
      align-items: center;
      margin: 8px 0;
      padding: 10px;
      background: #f5f9e9;
      border-radius: 4px;
    }
    
    .status-icon {
      margin-right: 10px;
      font-size: 20px;
    }
    
    .success { background: #d4edda; }
    .error { background: #f8d7da; }
    .warning { background: #fff3cd; }
    
    button {
      background: #36453b;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 10px 10px 0;
    }
    
    button:hover {
      background: #2a3630;
    }
    
    button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    
    pre {
      background: #f4f4f4;
      padding: 15px;
      border-radius: 4px;
      overflow-x: auto;
      font-size: 12px;
      line-height: 1.5;
    }
    
    .step {
      margin: 15px 0;
      padding: 15px;
      background: #fff;
      border-left: 4px solid #36453b;
    }
    
    .step-title {
      font-weight: bold;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß Push Notification Diagnostic</h1>
    
    <div class="section" style="background: #e3f2fd; border-left: 4px solid #2196f3;">
      <p style="margin: 0; color: #1565c0;">
        <strong>üí° Tip:</strong> This is a standalone diagnostic page. After testing, 
        <a href="/" style="color: #1976d2; text-decoration: underline;">go back to the main Adoras app</a> 
        to enable notifications from Settings ‚Üí Notifications.
      </p>
    </div>
    
    <div class="section">
      <h2>Current Status</h2>
      <div id="status-checks"></div>
    </div>
    
    <div class="section">
      <h2>Actions</h2>
      <button onclick="checkServiceWorker()">1. Check Service Worker</button>
      <button onclick="requestPermission()">2. Request Permission</button>
      <button onclick="getVapidKey()">3. Get VAPID Key</button>
      <button onclick="createSubscription()">4. Create Subscription</button>
      <button onclick="sendToBackend()">5. Send to Backend</button>
      <button onclick="runFullDiagnostic()">‚ñ∂Ô∏è Run Full Test</button>
    </div>
    
    <div class="section">
      <h2>Console Output</h2>
      <div id="console" style="max-height: 400px; overflow-y: auto;"></div>
    </div>
    
    <div class="section">
      <h2>iOS Troubleshooting Steps</h2>
      <div class="step">
        <div class="step-title">Step 1: Verify PWA Installation</div>
        <div>‚Ä¢ Go to iOS Home Screen</div>
        <div>‚Ä¢ Check if Adoras icon is present</div>
        <div>‚Ä¢ Open from home screen (not Safari)</div>
      </div>
      
      <div class="step">
        <div class="step-title">Step 2: Check iOS Settings</div>
        <div>‚Ä¢ Settings ‚Üí Adoras</div>
        <div>‚Ä¢ Notifications ‚Üí Allow Notifications (ON)</div>
        <div>‚Ä¢ Lock Screen, Notification Center, Banners (ALL ON)</div>
      </div>
      
      <div class="step">
        <div class="step-title">Step 3: Service Worker Status</div>
        <div>‚Ä¢ Run diagnostic above</div>
        <div>‚Ä¢ Look for "Service Worker: Active ‚úÖ"</div>
        <div>‚Ä¢ If not active, reinstall PWA</div>
      </div>
      
      <div class="step">
        <div class="step-title">Step 4: Clear and Reinstall</div>
        <div>1. Safari ‚Üí History ‚Üí Clear Website Data</div>
        <div>2. Delete PWA from home screen</div>
        <div>3. Reopen in Safari</div>
        <div>4. Share ‚Üí Add to Home Screen</div>
        <div>5. Open from home screen</div>
      </div>
    </div>
  </div>
  
  <script>
    let swRegistration;
    let pushSubscription;
    let vapidKey;
    
    // Console logging
    function log(message, type = 'info') {
      const consoleDiv = document.getElementById('console');
      const time = new Date().toLocaleTimeString();
      const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
      const div = document.createElement('div');
      div.style.margin = '5px 0';
      div.style.padding = '8px';
      div.style.background = type === 'success' ? '#d4edda' : type === 'error' ? '#f8d7da' : type === 'warning' ? '#fff3cd' : '#e9ecef';
      div.style.borderRadius = '4px';
      div.innerHTML = `<strong>${time}</strong> ${icon} ${message}`;
      consoleDiv.appendChild(div);
      consoleDiv.scrollTop = consoleDiv.scrollHeight;
      // Use window.console to access the browser console, not the DOM element
      window.console.log(`[${time}] ${icon} ${message}`);
    }
    
    // Update status display
    function updateStatus() {
      const statusDiv = document.getElementById('status-checks');
      statusDiv.innerHTML = '';
      
      const checks = [
        {
          label: 'Browser Supports Notifications',
          check: 'Notification' in window,
        },
        {
          label: 'Service Worker Supported',
          check: 'serviceWorker' in navigator,
        },
        {
          label: 'Push Manager Supported',
          check: 'PushManager' in window,
        },
        {
          label: 'Notification Permission',
          check: Notification.permission === 'granted',
          value: Notification.permission,
        },
        {
          label: 'Is Standalone PWA',
          check: window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone,
        },
        {
          label: 'Service Worker Registration',
          check: !!swRegistration,
          value: swRegistration ? 'Registered' : 'Not registered',
        },
        {
          label: 'Push Subscription',
          check: !!pushSubscription,
          value: pushSubscription ? 'Active' : 'Not subscribed',
        },
      ];
      
      checks.forEach(item => {
        const div = document.createElement('div');
        div.className = `status ${item.check ? 'success' : 'error'}`;
        div.innerHTML = `
          <span class="status-icon">${item.check ? '‚úÖ' : '‚ùå'}</span>
          <div>
            <strong>${item.label}</strong>
            ${item.value ? `<div style="font-size: 13px; color: #666;">${item.value}</div>` : ''}
          </div>
        `;
        statusDiv.appendChild(div);
      });
    }
    
    // Step 1: Check Service Worker
    async function checkServiceWorker() {
      log('Step 1: Checking service worker...', 'info');
      
      if (!('serviceWorker' in navigator)) {
        log('‚ùå Service worker not supported in this browser', 'error');
        log('Your browser does not support service workers. Push notifications will not work.', 'error');
        return false;
      }
      
      log('‚úÖ Service worker API is supported', 'success');
      
      try {
        log('Checking for existing service worker registration...', 'info');
        swRegistration = await navigator.serviceWorker.getRegistration();
        
        if (!swRegistration) {
          log('‚ö†Ô∏è No service worker currently registered', 'warning');
          log('Attempting to register service worker at /sw.js...', 'info');
          
          try {
            swRegistration = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
            log('‚úÖ Service worker registered successfully!', 'success');
            log(`Scope: ${swRegistration.scope}`, 'info');
          } catch (err) {
            log(`‚ùå Failed to register service worker: ${err.message}`, 'error');
            log(`Error name: ${err.name}`, 'error');
            log('üí° Make sure /sw.js exists and is accessible', 'warning');
            return false;
          }
        } else {
          log('‚úÖ Service worker already registered', 'success');
          log(`Scope: ${swRegistration.scope}`, 'info');
          log(`Active: ${!!swRegistration.active}`, 'info');
          log(`Installing: ${!!swRegistration.installing}`, 'info');
          log(`Waiting: ${!!swRegistration.waiting}`, 'info');
        }
        
        log('Waiting for service worker to be ready...', 'info');
        await navigator.serviceWorker.ready;
        log('‚úÖ Service worker is active and ready!', 'success');
        
        updateStatus();
        return true;
      } catch (error) {
        log(`‚ùå Service worker check failed: ${error.message}`, 'error');
        log(`Error stack: ${error.stack}`, 'error');
        return false;
      }
    }
    
    // Step 2: Request Permission
    async function requestPermission() {
      log('Step 2: Requesting notification permission...');
      
      if (!('Notification' in window)) {
        log('Notifications not supported', 'error');
        return false;
      }
      
      if (Notification.permission === 'granted') {
        log('Permission already granted', 'success');
        updateStatus();
        return true;
      }
      
      try {
        const permission = await Notification.requestPermission();
        log(`Permission result: ${permission}`, permission === 'granted' ? 'success' : 'error');
        
        if (permission === 'granted') {
          log('‚úÖ Permission granted! You can now subscribe to push notifications.', 'success');
        } else if (permission === 'denied') {
          log('‚ùå Permission denied. Please enable in iOS Settings ‚Üí Adoras ‚Üí Notifications', 'error');
        } else {
          log('‚ö†Ô∏è Permission dismissed. Try again.', 'warning');
        }
        
        updateStatus();
        return permission === 'granted';
      } catch (error) {
        log(`Permission request failed: ${error.message}`, 'error');
        return false;
      }
    }
    
    // Step 3: Get VAPID Key
    async function getVapidKey() {
      log('Step 3: Getting VAPID public key...');
      
      try {
        // Import the actual project ID from your app
        const projectId = 'cyaaksjydpegofrldxbo'; // Your Supabase project ID
        const publicAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5YWFrc2p5ZHBlZ29mcmxkeGJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMDYxMzEsImV4cCI6MjA3Njc4MjEzMX0.bL4r0JJWlSV6JjHnE4ArNFK53OkgLaPutacbekRcWxw';
        
        log('Fetching with Authorization header...', 'info');
        const response = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-deded1eb/notifications/vapid-public-key`, {
          headers: {
            'Authorization': `Bearer ${publicAnonKey}`
          }
        });
        
        if (!response.ok) {
          log(`Failed to get VAPID key: ${response.status} ${response.statusText}`, 'error');
          const text = await response.text();
          log(`Response: ${text}`, 'error');
          return false;
        }
        
        const data = await response.json();
        vapidKey = data.publicKey;
        log(`‚úÖ VAPID key received: ${vapidKey.substring(0, 30)}...`, 'success');
        
        return true;
      } catch (error) {
        log(`VAPID key fetch failed: ${error.message}`, 'error');
        return false;
      }
    }
    
    // Step 4: Create Push Subscription
    async function createSubscription() {
      log('Step 4: Creating push subscription...');
      
      if (!swRegistration) {
        log('No service worker registration. Run Step 1 first.', 'error');
        return false;
      }
      
      if (!vapidKey) {
        log('No VAPID key. Run Step 3 first.', 'error');
        return false;
      }
      
      try {
        // Convert VAPID key
        function urlBase64ToUint8Array(base64String) {
          const padding = '='.repeat((4 - base64String.length % 4) % 4);
          const base64 = (base64String + padding)
            .replace(/\-/g, '+')
            .replace(/_/g, '/');
          const rawData = window.atob(base64);
          const outputArray = new Uint8Array(rawData.length);
          for (let i = 0; i < rawData.length; ++i) {
            outputArray[i] = rawData.charCodeAt(i);
          }
          return outputArray;
        }
        
        pushSubscription = await swRegistration.pushManager.subscribe({
          userVisibleOnly: true,
          applicationServerKey: urlBase64ToUint8Array(vapidKey),
        });
        
        log('Push subscription created successfully!', 'success');
        log(`Endpoint: ${pushSubscription.endpoint.substring(0, 50)}...`, 'success');
        
        updateStatus();
        return true;
      } catch (error) {
        log(`Push subscription failed: ${error.message}`, 'error');
        log(`Error name: ${error.name}`, 'error');
        return false;
      }
    }
    
    // Step 5: Send to Backend
    async function sendToBackend() {
      log('Step 5: Sending subscription to backend...');
      
      if (!pushSubscription) {
        log('No push subscription. Run Step 4 first.', 'error');
        return false;
      }
      
      try {
        const projectId = 'cyaaksjydpegofrldxbo'; // Your Supabase project ID
        const publicAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5YWFrc2p5ZHBlZ29mcmxkeGJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMDYxMzEsImV4cCI6MjA3Njc4MjEzMX0.bL4r0JJWlSV6JjHnE4ArNFK53OkgLaPutacbekRcWxw';
        
        log('Sending with Authorization header...', 'info');
        const response = await fetch(`https://${projectId}.supabase.co/functions/v1/make-server-deded1eb/notifications/subscribe`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${publicAnonKey}`
          },
          body: JSON.stringify({
            userId: 'diagnostic-user',
            subscription: pushSubscription.toJSON(),
            deviceInfo: {
              userAgent: navigator.userAgent,
              platform: navigator.platform,
            },
          }),
        });
        
        if (!response.ok) {
          const text = await response.text();
          log(`‚ùå Backend save failed: ${response.status} ${text}`, 'error');
          return false;
        }
        
        const result = await response.json();
        log('‚úÖ Subscription saved to backend successfully!', 'success');
        log(`Response: ${JSON.stringify(result)}`, 'success');
        
        return true;
      } catch (error) {
        log(`Backend save failed: ${error.message}`, 'error');
        return false;
      }
    }
    
    // Run Full Diagnostic
    async function runFullDiagnostic() {
      try {
        log('='.repeat(50), 'info');
        log('üöÄ STARTING FULL DIAGNOSTIC', 'info');
        log('='.repeat(50), 'info');
        
        log('Running Step 1 of 5: Service Worker Check...', 'info');
        const step1 = await checkServiceWorker();
        if (!step1) {
          log('‚ùå FAILED at Step 1: Service Worker not available', 'error');
          log('üí° Solution: The main Adoras app should register the service worker. Try closing and reopening the app from the home screen.', 'warning');
          return;
        }
        log('‚úÖ Step 1 PASSED', 'success');
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        log('Running Step 2 of 5: Permission Check...', 'info');
        const step2 = await requestPermission();
        if (!step2) {
          log('‚ùå FAILED at Step 2: Permission not granted', 'error');
          log('üí° Solution: Go to iOS Settings ‚Üí Adoras ‚Üí Notifications ‚Üí Allow Notifications', 'warning');
          return;
        }
        log('‚úÖ Step 2 PASSED', 'success');
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        log('Running Step 3 of 5: VAPID Key Fetch...', 'info');
        const step3 = await getVapidKey();
        if (!step3) {
          log('‚ùå FAILED at Step 3: Could not fetch VAPID key from server', 'error');
          log('üí° Solution: Check your internet connection and server status', 'warning');
          return;
        }
        log('‚úÖ Step 3 PASSED', 'success');
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        log('Running Step 4 of 5: Push Subscription...', 'info');
        const step4 = await createSubscription();
        if (!step4) {
          log('‚ùå FAILED at Step 4: Could not create push subscription', 'error');
          log('üí° Solution: This usually means iOS restrictions. Make sure you opened this from the PWA on home screen, not Safari.', 'warning');
          return;
        }
        log('‚úÖ Step 4 PASSED', 'success');
        
        await new Promise(resolve => setTimeout(resolve, 1000));
        
        log('Running Step 5 of 5: Backend Save...', 'info');
        const step5 = await sendToBackend();
        if (!step5) {
          log('‚ùå FAILED at Step 5: Could not save subscription to backend', 'error');
          log('üí° Solution: Check server logs for errors', 'warning');
          return;
        }
        log('‚úÖ Step 5 PASSED', 'success');
        
        log('='.repeat(50), 'success');
        log('üéâ ALL STEPS PASSED! Push notifications should work!', 'success');
        log('='.repeat(50), 'success');
      } catch (error) {
        log(`‚ùå Unexpected error during diagnostic: ${error.message}`, 'error');
        window.console.error('Diagnostic error:', error);
      }
    }
    
    // Initialize
    updateStatus();
    
    // Check if opened from PWA
    const isStandalone = window.matchMedia('(display-mode: standalone)').matches || window.navigator.standalone;
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    
    if (isIOS && !isStandalone) {
      log('‚ö†Ô∏è WARNING: You opened this page in Safari, not from the PWA!', 'warning');
      log('‚ö†Ô∏è Push notifications only work when opened from the home screen icon.', 'warning');
      log('üí° Close this and open Adoras from your home screen, then navigate to Settings ‚Üí Notifications', 'warning');
    } else if (isIOS && isStandalone) {
      log('‚úÖ Good! You opened this from the PWA (home screen icon)', 'success');
    }
    
    log('Diagnostic tool loaded and ready.', 'info');
  </script>
</body>
</html>
