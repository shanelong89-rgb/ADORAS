<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Fix Shane's Connection</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, sans-serif;
      background: #1a1a2e;
      color: white;
      padding: 20px;
      line-height: 1.6;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    h1 { margin-bottom: 20px; }
    button {
      background: #667eea;
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 16px;
      cursor: pointer;
      margin: 10px 10px 20px 0;
    }
    button:hover { background: #5568d3; }
    button.danger { background: #e74c3c; }
    button.danger:hover { background: #c0392b; }
    pre {
      background: #0f3460;
      padding: 20px;
      border-radius: 8px;
      overflow-x: auto;
      margin-top: 20px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }
    .section {
      background: #16213e;
      padding: 20px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .error { color: #ff6b6b; }
    .success { color: #51cf66; }
    .warning { color: #ffd93d; }
    input {
      width: 100%;
      padding: 10px;
      border: 1px solid #667eea;
      border-radius: 6px;
      background: #0f3460;
      color: white;
      font-size: 14px;
      margin: 10px 0;
    }
    label { display: block; margin-top: 10px; font-weight: bold; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîß Fix Shane's Connection</h1>
    
    <div class="section">
      <h2>Issue Summary</h2>
      <p><strong>Shane's ID:</strong> <code>177cc25a-5062-48e0-81b5-af5701bc3e77</code></p>
      <p><strong>Orphaned Connection:</strong> <code>1761271821274-jwolla1</code></p>
      <p><strong>CORRECT Allison ID (Unknown):</strong> <code>c2d51ad1-7386-4ce3-99a3-6fed398b99a7</code></p>
      <p><strong>WRONG ID (showing as "allison tam"):</strong> <code>a6ade4b8-a80e-4e34-90e8-455f73ae0dcc</code></p>
    </div>

    <div class="section">
      <h2>Step 1: Check User Profiles</h2>
      <button onclick="checkProfiles()">Check Both User IDs</button>
    </div>

    <div class="section">
      <h2>Step 2: Create/Fix Allison's Profile</h2>
      <p>If the CORRECT ID is missing a profile, we'll create one:</p>
      <label>Name:</label>
      <input type="text" id="name" value="allison tam" />
      <label>Email:</label>
      <input type="text" id="email" value="allison.tam@hotmail.com" />
      <label>Role:</label>
      <input type="text" id="role" value="keeper" />
      <button onclick="createProfile()">Create/Update Profile</button>
    </div>

    <div id="results"></div>
  </div>

  <script>
    const API = 'https://cyaaksjydpegofrldxbo.supabase.co/functions/v1/make-server-deded1eb';
    const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5YWFrc2p5ZHBlZ29mcmxkeGJvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjEyMDYxMzEsImV4cCI6MjA3Njc4MjEzMX0.bL4r0JJWlSV6JjHnE4ArNFK53OkgLaPutacbekRcWxw';

    const CORRECT_ALLISON_ID = 'c2d51ad1-7386-4ce3-99a3-6fed398b99a7';
    const WRONG_ID = 'a6ade4b8-a80e-4e34-90e8-455f73ae0dcc';

    async function checkProfiles() {
      const results = document.getElementById('results');
      results.innerHTML = '<div class="section">Loading...</div>';

      try {
        // Check both user IDs
        const [correctRes, wrongRes] = await Promise.all([
          fetch(`${API}/admin/check-user-by-id/${CORRECT_ALLISON_ID}`, {
            headers: { 'Authorization': `Bearer ${KEY}` }
          }),
          fetch(`${API}/admin/check-user-by-id/${WRONG_ID}`, {
            headers: { 'Authorization': `Bearer ${KEY}` }
          })
        ]);

        const correctData = await correctRes.json();
        const wrongData = await wrongRes.json();
        
        let html = '<div class="section">';
        html += '<h2>User Profile Check Results</h2>';
        
        html += '<h3>CORRECT Allison ID: <code>' + CORRECT_ALLISON_ID + '</code></h3>';
        if (correctData.exists) {
          html += '<div style="padding: 10px; background: #1a472a; border-radius: 6px; margin: 10px 0;">';
          html += '‚úÖ Profile EXISTS<br>';
          html += 'Name: ' + correctData.profile.name + '<br>';
          html += 'Email: ' + correctData.profile.email + '<br>';
          html += 'Type: ' + correctData.profile.type;
          html += '</div>';
        } else {
          html += '<div style="padding: 10px; background: #7d1128; border-radius: 6px; margin: 10px 0;">';
          html += '‚ùå Profile MISSING - This is the problem!<br>';
          html += 'Use "Create/Update Profile" below to fix this.';
          html += '</div>';
        }

        html += '<h3>WRONG ID: <code>' + WRONG_ID + '</code></h3>';
        if (wrongData.exists) {
          html += '<div style="padding: 10px; background: #0f3460; border-radius: 6px; margin: 10px 0;">';
          html += '‚ÑπÔ∏è Profile exists<br>';
          html += 'Name: ' + wrongData.profile.name + '<br>';
          html += 'Email: ' + wrongData.profile.email + '<br>';
          html += 'Type: ' + wrongData.profile.type;
          html += '</div>';
        } else {
          html += '<div style="padding: 10px; background: #0f3460; border-radius: 6px; margin: 10px 0;">';
          html += '‚ÑπÔ∏è Profile not found';
          html += '</div>';
        }

        html += '</div>';
        results.innerHTML = html;
      } catch (error) {
        results.innerHTML = `<div class="section error">‚ùå Error: ${error.message}</div>`;
        console.error(error);
      }
    }

    async function createProfile() {
      const results = document.getElementById('results');
      results.innerHTML = '<div class="section">Creating profile...</div>';

      const name = document.getElementById('name').value;
      const email = document.getElementById('email').value;
      const role = document.getElementById('role').value;

      try {
        const res = await fetch(`${API}/admin/create-user-profile`, {
          method: 'POST',
          headers: { 
            'Authorization': `Bearer ${KEY}`,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            userId: CORRECT_ALLISON_ID,
            name: name,
            email: email,
            type: role,
            relationship: '',
            bio: ''
          })
        });

        const data = await res.json();

        let html = '<div class="section">';
        if (data.success) {
          html += '<h2 class="success">‚úÖ Profile Created Successfully!</h2>';
          html += '<p>User ID: <code>' + data.profile.id + '</code></p>';
          html += '<p>Name: ' + data.profile.name + '</p>';
          html += '<p>Email: ' + data.profile.email + '</p>';
          html += '<p>Type: ' + data.profile.type + '</p>';
          html += '<hr style="margin: 20px 0; border: 1px solid #667eea;">';
          html += '<h3>‚úÖ What happens now?</h3>';
          html += '<p>The connection "1761271821274-jwolla1" should now show "allison tam" instead of "Unknown"!</p>';
          html += '<p>Go back to <a href="/diagnose-shane.html" style="color: #667eea;">diagnose-shane.html</a> and run it again to verify the fix.</p>';
        } else {
          html += '<h2 class="error">‚ùå Failed to create profile</h2>';
          html += '<p>' + data.error + '</p>';
        }
        html += '</div>';

        results.innerHTML = html;
      } catch (error) {
        results.innerHTML = `<div class="section error">‚ùå Error: ${error.message}</div>`;
        console.error(error);
      }
    }
  </script>
</body>
</html>
